<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Sean Hoang">
    <meta name="description" content="ZotMealTrackerPage">
    <title>WebJamSubmission</title>

    
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='web-jam-favicon.ico') }}">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}">

    <!-- Bootstrap for mogging and jquery for server yapping -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <header class='darkZotBlue text-white text-center py-3' id='topBanner'>
        <h1>Zot Meal Tracker</h1>
    </header>

    <nav class="navbar navbar-expand-lg navbar-light bg-light" id="navbar"> <a class="navbar-brand ps-3"
            href="#">Navigation</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span> </button>
        <div class="collapse navbar-collapse text-end pe-3" id="navbarNav">
            <ul class='navbar-nav'>
                <li class="nav-item active"> <a class="nav-link" href="#">Home <span
                            class="sr-only">(current)</span></a> </li>
                <li class="nav-item"> <a class="nav-link" href="#howTo">How To</a> </li>
                <li class="nav-item"> <a class="nav-link" href="#healthFormStart">Meal Calculator</a> </li>
                <li class="nav-item"> <a class="nav-link" href="#footer">Footer</a> </li>
            </ul>
        </div>
    </nav>
    <div class="container mt-5">
        <section class="row justify-content-center">
            <div class="col-md-8">
                <article class="about-section">
                    <h1 class="display-4" id='howTo'>How to Use:</h1>
                    <button class="btn btn-link mt-3" data-bs-toggle="collapse" data-bs-target="#instructions"
                        aria-expanded="false" aria-controls="instructions">
                        <span class="triangle"></span>
                    </button>
                    <div class="collapse mt-3" id="instructions">
                        <p>
                            First you enter the location of the meal you want to select
                            Then you choose which menu (breakfast, lunch, dinner). This means you
                            can get your macros from your favorite places
                        </p>
                        <p>
                            Then you enter your physical attributes (sex, age, weight, height) so we can get a
                            better measure of your dietary needs.
                        </p>
                        <p>
                            Finally meals are ranked based on how close they meet your nutritional needs and are
                            weighted based on how important they are (ie. calories are more important than vitamins)
                        </p>
                    </div>
                </article>
            </div>
        </section>
    </div>

    <div class="container mt-4">
        <form id="healthForm" class="p-4 border rounded shadow-sm" novalidate>
            <fieldset>
                <legend class="text-center mb-4">Health Information</legend>

                <!-- Restaurants Dropdown -->
                <div class="row mb-3" id='healthFormStart'>
                    <div class="col-md-6">
                        <label for="location" class="form-label">Location</label>
                        <select id="location" name="location" class="form-select" required>
                            <option value="">Choose a Location</option>
                            <option value="anteatery">Anteatery</option>
                            <option value="brandywine">Brandywine</option>
                        </select>
                        <div class="invalid-feedback">Please select a location.</div>
                    </div>

                    <!-- Menus Dropdown -->
                    <div class="col-md-6">
                        <label for="menu" class="form-label">Menu</label>
                        <select id="menu" name="menu" class="form-select" required>
                            <option value="">Choose a Menu</option>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                        <div class="invalid-feedback">Please select a menu.</div>
                    </div>
                </div>

                <!-- Sex Buttons ( ͡~ ͜ʖ ͡°)-->
                <div class="mb-3">
                    <label class="form-label">Sex</label>
                    <div class="d-flex">
                        <div class="form-check me-3">
                            <input type="radio" class="form-check-input" name="sex" id="male" value="male" required>
                            <label class="form-check-label" for="male">Male</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="sex" id="female" value="female" required>
                            <label class="form-check-label" for="female">Female</label>
                        </div>
                    </div>
                    <div class="invalid-feedback">Please select a sex.</div>
                </div>

                <!-- Numeric Inputs (age, weight, height)-->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="age" class="form-label">Age</label>
                        <input type="number" class="form-control" id="age" name="age" min="0" max="120" required>
                        <div class="invalid-feedback">Please enter a valid age (0-120).</div>
                    </div>
                    <div class="col-md-4">
                        <label for="weight" class="form-label">Weight (lbs)</label>
                        <input type="number" step="0.1" class="form-control" id="weight" name="weight" min="0"
                            max="1000" required>
                        <div class="invalid-feedback">Please enter a valid weight (0-1000 lbs).</div>
                    </div>
                    <div class="col-md-4">
                        <label for="height" class="form-label">Height (in)</label>
                        <input type="number" step="0.1" class="form-control" id="height" name="height" min="0" max="120"
                            required>
                        <div class="invalid-feedback">Please enter a valid height (0-120 in).</div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm me-1 d-none" role="status" aria-hidden="true"></span>
                    Submit
                </button>
            </fieldset>
        </form>

        <!-- Result Container -->
        <div id="resultContainer" class="meal-section mt-4">
            <!-- Backend-generated content will be inserted here -->
        </div>
    </div>

    <!-- Footer -->
    <footer id="footer" class="bg-light text-center text-lg-start mt-5">
        <div class="text-center p-3">
            ADD CREDITS HERE
        </div>
    </footer>
    <!-- TODO: extract this into multiple js files -->
    <script>
        document.getElementById('healthForm').addEventListener('submit', function (event) {
            // Prevent default form submission
            event.preventDefault();

            // Check form validity based on types in <input type = ...>
            if (!this.checkValidity()) {
                event.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            // Create FormData object (uses name as key and value as the value)
            const formData = new FormData(this);

            // Convert FormData to an object
            const formObject = {};

            for (let [key, value] of formData.entries()) {
                // Exclude empty values and default placeholder options
                if (value && value !== '') {
                    // Convert numeric fields to appropriate types
                    if (key === 'age' || key === 'weight' || key === 'height') {
                        formObject[key] = parseFloat(value);
                    } else {
                        formObject[key] = value.trim();
                    }
                }
            }

            // Verify we have all required fields
            const requiredFields = ['location', 'menu', 'sex', 'age', 'weight', 'height'];
            const missingFields = requiredFields.filter(field => !formObject[field]);

            if (missingFields.length > 0) {
                alert(`Please complete all required fields: ${missingFields.join(', ')}`);
                return;
            }

            // Disable submit button and show loading spinner
            const submitButton = this.querySelector('button[type="submit"]');
            const spinner = submitButton.querySelector('.spinner-border');
            submitButton.disabled = true;
            spinner.classList.remove('d-none');

            // Send data via Fetch API asynchron however you spell it
            // This makes it so you don't have to reload the page
            fetch('/submit-health-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formObject)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server Error: ${response.statusText}`);
                    }
                    return response.text(); // Assuming server returns an HTML snippet
                })
                .then(htmlTemplate => {
                    // Insert the HTML snippet into the container
                    const resultContainer = document.getElementById('resultContainer');
                    resultContainer.innerHTML = htmlTemplate;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('resultContainer').innerHTML = `
            <div class="alert alert-danger" role="alert">
                An error occurred: ${error.message}
            </div>
        `;
                })
                .finally(() => {
                    // Cleanup: Re-enable button, hide spinner
                    submitButton.disabled = false;
                    spinner.classList.add('d-none');
                });
        });
    </script>
</body>

</html>
